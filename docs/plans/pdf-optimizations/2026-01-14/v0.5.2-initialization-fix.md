# PDF Initialization Fix - v0.5.2

## Summary

Fixed critical PDF rendering initialization bugs that caused blank pages on first load.

## Changes Made

### File: `apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts`

#### 1. Viewport Rect Caching Fix (lines 562-564)

**Problem**: `cachedViewportRect` was never set during `initialize()`, causing `getViewportRect()` to return null/undefined on first render. This broke all visibility calculations.

**Fix**:
```typescript
// CRITICAL: Cache viewport rect for visibility calculations
// Without this, getViewportRect() returns null on first render, causing blank pages
this.cachedViewportRect = viewportRect;
```

#### 2. Page Element Creation Fix (line 572)

**Problem**: `setupInitialView()` was called but `updateVisiblePages()` was never called after it, so page elements were never created during initialization.

**Fix**:
```typescript
if (viewportRect.width > 0 && viewportRect.height > 0) {
  this.setupInitialView();
  this.updateVisiblePages(); // CRITICAL: Create page elements for initial view
}
```

## Root Cause Analysis

The initialization flow was:

```
initialize()
  ├── calculatePageLayouts() ✓ (layouts created: 947)
  ├── updateCanvasSize() ✓
  ├── cameraConstraints.viewport = {...} ✓
  ├── cachedViewportRect = ??? ✗ (MISSING!)
  ├── setupInitialView() ✓
  └── updateVisiblePages() ✗ (MISSING!)
```

Without `cachedViewportRect`, visibility calculations returned NaN/undefined dimensions, preventing any pages from being identified as "visible".

Without `updateVisiblePages()`, no page elements were created even if visibility worked.

## Verification

1. **Fresh PDF load**: Pages now render correctly on initial load
2. **Viewport caching confirmed**: `cachedViewportRect` shows valid dimensions (e.g., 1091×1622)
3. **Page elements created**: 4 page elements created with tiles on init
4. **Render queue processing**: `isRendering: true` immediately after open

## Testing Protocol

```javascript
// Verify via MCP after opening PDF
(function() {
  const leaves = app.workspace.getLeavesOfType('amnesia-reader');
  const view = leaves[0]?.view;
  const canvas = view?.component?.$$.ctx?.[3]?.infiniteCanvas;

  return {
    viewportCached: canvas?.cachedViewportRect ? 'OK' : 'MISSING',
    pageElements: canvas?.pageElements?.size || 0,
    isRendering: canvas?.isRendering
  };
})();
```

## Related Issues

- This fix resolves the "blank pages on initial load" symptom
- High-zoom rendering (8x+) still has some latency due to tile render time
- The ZoomStateMachine settling delay (200ms) is working as designed

## Version

- **Version**: 0.5.2
- **Date**: 2026-01-14
