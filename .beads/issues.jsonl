{"id":"amnesia-0k4","title":"Wire ZoomStateManager to pdf-gesture-handler","description":"## Context\npdf-gesture-handler needs to call ZoomStateManager for rebound filtering\nand activity signaling.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-gesture-handler.ts`\n\n## Changes Required\n\n### 1. Add ZoomStateManager reference\n```typescript\nprivate zoomStateManager: ZoomStateManager | null = null;\n\nsetZoomStateManager(manager: ZoomStateManager): void {\n  this.zoomStateManager = manager;\n}\n```\n\n### 2. Add rebound filtering in handleWheel (~line 108-135)\n```typescript\nhandleWheel(event: WheelEvent): void {\n  // ... existing code ...\n  \n  // Add rebound filtering at zoom boundaries\n  if (this.zoomStateManager) {\n    if (this.zoomStateManager.isReboundZoomOut(newScale)) {\n      console.log('[GestureHandler] Filtered rebound event at max zoom');\n      this.zoomStateManager.signalOngoingActivity();\n      return;\n    }\n  }\n  \n  // ... continue with zoom ...\n}\n```\n\n### 3. Signal gesture end\n```typescript\n// When gesture timeout fires\nif (this.zoomStateManager) {\n  this.zoomStateManager.markGestureEnd();\n}\n```\n\n## Acceptance Criteria\n- [ ] `setZoomStateManager()` method added\n- [ ] Rebound filtering integrated in handleWheel\n- [ ] Gesture end signaled to ZoomStateManager\n- [ ] Console logs show rebound filtering at max zoom\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Rebound events filtered at 16x zoom\n- [ ] Gesture end correctly detected","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:34:54.568176-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:50:55.554788-06:00","closed_at":"2026-01-20T01:50:55.554788-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-0k4","depends_on_id":"amnesia-x9v","type":"blocks","created_at":"2026-01-20T01:35:28.678378-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-0k4","depends_on_id":"amnesia-5so","type":"blocks","created_at":"2026-01-20T01:35:28.738554-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-0pf","title":"Cleanup: Final architecture validation - Two-Track Pipeline compliance","description":"## Context\nFinal validation that the Two-Track Pipeline architecture is fully implemented\nand no legacy patterns remain.\n\n## Validation Checklist\n\n### Track 1: Interaction (Synchronous/GPU)\n- [ ] CSS transforms update every frame via ZoomStateManager\n- [ ] Wheel event → State → Transform: \u003c5ms\n- [ ] GPU compositing active (will-change: transform)\n- [ ] NO canvas operations in hot path\n\n### Track 2: Refinement (Asynchronous/CPU)\n- [ ] Tiles render in background workers\n- [ ] Epoch validation rejects stale tiles gracefully\n- [ ] No blank screens during zoom\n- [ ] Mode transitions are seamless\n\n### State Management\n- [ ] ZoomStateManager is SINGLE source of truth\n- [ ] ZoomOrchestrator deprecated and unused\n- [ ] renderVersion removed\n- [ ] No duplicate state tracking\n\n### Code Quality\n- [ ] No TODOs blocking functionality\n- [ ] No dead code paths\n- [ ] No 'exists but not wired' patterns\n- [ ] Clear separation of concerns\n\n## Quality Gate: Code Reviewer Agent Check\nRun `feature-dev:code-reviewer` agent with prompt:\n```\nFinal architecture validation for PDF zoom rendering Two-Track Pipeline.\n\nVerify:\n1. INTERACTION TRACK: CSS transforms update synchronously via ZoomStateManager\n   - Check getCameraTransform() is called on every zoom event\n   - Verify no canvas operations in gesture handling hot path\n   \n2. REFINEMENT TRACK: Tiles render asynchronously with epoch validation\n   - Check epoch flows from ZoomStateManager → render-coordinator → pdf-page-element\n   - Verify stale tiles are SKIPPED (not REJECTED causing blank screens)\n   \n3. STATE MANAGEMENT: ZoomStateManager is single source of truth\n   - Verify no duplicate zoom state tracking\n   - Verify ZoomOrchestrator is deprecated and unused\n   - Verify renderVersion is removed\n   \n4. PATTERNS TO FLAG:\n   - Any 'correct logic exists but isn't wired'\n   - Any 'two implementations of same thing'\n   - Any 'hardcoded values that should come from state'\n   - Any 'TODO/FIXME that blocks functionality'\n\nProvide PASS/FAIL verdict with specific file:line references for any issues.\n```\n\n## Acceptance Criteria\n- [ ] Code reviewer agent reports PASS on all 4 validation areas\n- [ ] Integration test (amnesia-ecj) passes\n- [ ] 60fps maintained during zoom gestures\n- [ ] No focal point drift at any zoom level\n- [ ] No blank screens during rapid zoom\n\n## Quality Gates\n- [ ] Build passes\n- [ ] All previous cleanup issues closed\n- [ ] Code reviewer agent PASS verdict\n- [ ] Manual testing with real trackpad gestures PASS","status":"open","priority":2,"issue_type":"chore","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:38:24.403778-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:38:24.403778-06:00","dependencies":[{"issue_id":"amnesia-0pf","depends_on_id":"amnesia-9pu","type":"blocks","created_at":"2026-01-20T01:38:32.322307-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-0pf","depends_on_id":"amnesia-ray","type":"blocks","created_at":"2026-01-20T01:38:32.374114-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-0pf","depends_on_id":"amnesia-ao7","type":"blocks","created_at":"2026-01-20T01:38:32.42498-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-0pf","depends_on_id":"amnesia-kuj","type":"blocks","created_at":"2026-01-20T01:38:32.477941-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-0pf","depends_on_id":"amnesia-jd3","type":"blocks","created_at":"2026-01-20T01:38:32.528164-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-0pf","depends_on_id":"amnesia-ecj","type":"blocks","created_at":"2026-01-20T01:38:32.57867-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-166","title":"Wire rebound window detection in zoom handling pipeline","description":"**SUPERSEDED by amnesia-0k4 (Option A: Full ZoomStateManager Wiring)**\n\nThis quick-patch approach is replaced by the full ZoomStateManager wiring which:\n- Integrates rebound detection directly into ZoomStateManager\n- Wires pdf-gesture-handler to call ZoomStateManager.isReboundZoomOut()\n- Provides cleaner architecture\n\nSee amnesia-0k4 for the full implementation.","status":"deferred","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:18:59.150018-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:36:30.5176-06:00","dependencies":[{"issue_id":"amnesia-166","depends_on_id":"amnesia-ntj","type":"blocks","created_at":"2026-01-20T01:20:07.091379-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-1fr","title":"P1: Wire Epoch Validation to renderTiles()","description":"**Priority:** P1 (High)\n**Council Consensus:** Mandatory for async rendering pipeline. Prevents \"time travel\" bugs.\n\n## Problem\nThe `currentEpoch` parameter is never passed to `renderTiles()`:\n```typescript\n// pdf-page-element.ts:628-656\nconst epochValid = currentEpoch === undefined || ... // ← always true!\n```\n\nBecause `currentEpoch` defaults to `undefined`, epoch validation NEVER rejects stale snapshots. Tiles from zoom epoch N are incorrectly used for epoch N+1, causing coordinate drift.\n\n## Implementation\n1. Find all `renderTiles()` calls in `pdf-infinite-canvas.ts`\n2. Pass `this.renderVersion` as `currentEpoch` parameter\n3. Ensure `renderVersion` increments on every zoom change\n4. Add validation logging to confirm stale tiles are rejected\n\n## Files to Modify\n- `pdf-infinite-canvas.ts` (all `element.renderTiles()` calls)\n- `pdf-page-element.ts` (verify epoch check logic)","acceptance_criteria":"## Success Criteria (ALL must pass)\n\n### Functional Tests\n- [ ] **Epoch Passed:** All `renderTiles()` calls include `currentEpoch` parameter\n- [ ] **Validation Active:** Console shows epoch mismatch warnings during rapid zoom\n- [ ] **Stale Rejection:** Old tiles from previous zoom level never appear after zoom change\n\n### Test Scenarios\n- [ ] **Rapid Zoom In/Out:** Zoom from 1x → 8x → 1x rapidly; no old tiles flash on screen\n- [ ] **Interrupted Render:** Start zoom, wait 100ms, zoom again; first render should be cancelled\n- [ ] **Mode Transition:** Cross 4x threshold; tiles from old mode don't leak into new mode\n\n### Validation Commands (Run in Obsidian DevTools)\n```javascript\n// Should see epoch in render calls\nwindow.pdfLifecycleTests?.getLastRenderEpoch?.() !== undefined\n\n// Should see cancellation messages in console\n// \"[PDFPageElement] Transform snapshot epoch mismatch...\"\n```\n\n### Regression Checks\n- [ ] Normal zoom still renders tiles correctly\n- [ ] No performance degradation from epoch checks\n- [ ] Cache hit rate not affected","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-20T00:15:37.716065-06:00","updated_at":"2026-01-20T00:37:34.690492-06:00","closed_at":"2026-01-20T00:37:34.690492-06:00","close_reason":"Already implemented: renderVersion passed as currentEpoch to renderTiles(), TransformSnapshot includes epoch, validation logic in pdf-page-element.ts working. Code analysis confirms full implementation.","labels":["council-validated","p1-high","pdf","zoom"],"dependencies":[{"issue_id":"amnesia-1fr","depends_on_id":"amnesia-6ii","type":"parent-child","created_at":"2026-01-20T00:16:43.883189-06:00","created_by":"daemon"},{"issue_id":"amnesia-1fr","depends_on_id":"amnesia-dxm","type":"blocks","created_at":"2026-01-20T00:16:50.5773-06:00","created_by":"daemon"}]}
{"id":"amnesia-36x","title":"Test focal point drift fix with real trackpad gestures","description":"Build, deploy, and test:\n1. npm run build in apps/amnesia\n2. Copy to test vault\n3. Reload plugin via MCP\n4. Pinch-zoom 1x-8x with real trackpad\n5. Hold gesture 2-3 seconds at max zoom\n6. Release - focal point should NOT drift\n7. Repeat 5 times for consistency","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T14:44:48.961206-06:00","updated_at":"2026-01-19T21:11:17.40264-06:00","closed_at":"2026-01-19T21:11:17.40264-06:00","close_reason":"TransformSnapshot implementation verified - logs show snapshot capture at request time, epoch tracking, and snapshot usage at display time. Real trackpad testing needed for final drift verification.","labels":["drift-fix","pdf","testing"],"dependencies":[{"issue_id":"amnesia-36x","depends_on_id":"amnesia-7wn","type":"blocks","created_at":"2026-01-19T14:44:56.515949-06:00","created_by":"daemon"}]}
{"id":"amnesia-3of","title":"Increment epoch (renderVersion) on every zoom change","description":"**SUPERSEDED by amnesia-5so (Option A: Full ZoomStateManager Wiring)**\n\nThis quick-patch approach is replaced by the full ZoomStateManager wiring which:\n- Implements correct epoch logic at the source (ZoomStateManager)\n- Provides single source of truth for zoom state\n- Eliminates renderVersion entirely\n\nSee amnesia-5so for the full implementation.","status":"closed","priority":0,"issue_type":"bug","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:18:48.050636-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T02:57:29.105156-06:00","closed_at":"2026-01-20T02:57:29.105156-06:00","close_reason":"Closed"}
{"id":"amnesia-4h3","title":"Add mode-switch hysteresis during active gestures","description":"## Context\nisViewportOnly is calculated fresh on every renderTiles() with no hysteresis.\nMode can flip between frames if user pans while zooming.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-page-element.ts`\n\n## Current Behavior (Lines 723-725)\n```typescript\nconst isViewportOnly = minTileX \u003e 0 || minTileY \u003e 0 ||\n  (maxTileX + 1) * pdfTileSize \u003c pdfWidth - pdfTileSize ||\n  (maxTileY + 1) * pdfTileSize \u003c pdfHeight - pdfTileSize;\n```\n\n## Problem\n- Frame 1: Full coverage → isViewportOnly=false → full-page CSS\n- Frame 2: Slight pan → isViewportOnly=true → viewport-only CSS\n- Visual jump from CSS size/transform change\n\n## Fix\nAdd hysteresis or gesture-awareness:\n```typescript\n// Lock mode during active gesture\nif (this.isGestureActive \u0026\u0026 this.lockedMode !== null) {\n  isViewportOnly = this.lockedMode === 'viewport-only';\n} else {\n  isViewportOnly = /* calculation */;\n  if (!this.isGestureActive) {\n    this.lockedMode = isViewportOnly ? 'viewport-only' : 'full-page';\n  }\n}\n```\n\n## Acceptance Criteria\n- [ ] Mode does NOT switch during active zoom/pan gesture\n- [ ] Mode switch only occurs after gesture settles\n- [ ] Hysteresis prevents oscillation at threshold\n\n## Quality Gates\n- [ ] Build passes\n- [ ] No visual jumps when panning at mode boundary\n- [ ] Mode transitions smooth after gesture ends","status":"closed","priority":3,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:19:42.396538-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:31:53.219703-06:00","closed_at":"2026-01-20T03:31:53.219703-06:00","close_reason":"Mostly addressed by amnesia-z8v (deferred mode transitions to gesture end). Canvas-level mode changes now defer to gesture end, preventing CSS jumps. The isViewportOnly calculation in renderTiles() is less critical since parent defers mode changes. If visual jumps persist, can revisit.","dependencies":[{"issue_id":"amnesia-4h3","depends_on_id":"amnesia-8jm","type":"blocks","created_at":"2026-01-20T01:20:07.510538-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-4rl","title":"Add soft constraint support to ZoomStateManager","description":"## Context\nCouncil mandated: Soft constraints during gesture, hard constraints at gesture end.\nZoomStateManager needs to support both constraint modes.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/zoom-state-manager.ts`\n\n## Implementation\n```typescript\ninterface ZoomStateConfig {\n  // ... existing fields\n  softConstraintFactor: number;  // 0.3 = 30% rubber-band resistance\n}\n\n// Add to ZoomStateManager class\nconstrainCamera(isGestureActive: boolean): Camera {\n  if (isGestureActive) {\n    return this.applySoftConstraints();\n  }\n  return this.applyHardConstraints();\n}\n\nprivate applySoftConstraints(): Camera {\n  const { x, y, zoom } = this.state;\n  const { minX, maxX, minY, maxY } = this.calculateBounds(zoom);\n  \n  let targetX = x, targetY = y;\n  const factor = this.config.softConstraintFactor;\n  \n  if (x \u003c minX) targetX = minX + (x - minX) * factor; // Rubber-band\n  if (x \u003e maxX) targetX = maxX + (x - maxX) * factor;\n  if (y \u003c minY) targetY = minY + (y - minY) * factor;\n  if (y \u003e maxY) targetY = maxY + (y - maxY) * factor;\n  \n  return { x: targetX, y: targetY, z: zoom };\n}\n\nprivate applyHardConstraints(): Camera {\n  const { x, y, zoom } = this.state;\n  const { minX, maxX, minY, maxY } = this.calculateBounds(zoom);\n  \n  return {\n    x: Math.max(minX, Math.min(maxX, x)),\n    y: Math.max(minY, Math.min(maxY, y)),\n    z: zoom\n  };\n}\n```\n\n## Acceptance Criteria\n- [ ] `constrainCamera(isGestureActive)` routes to correct constraint mode\n- [ ] Soft constraints allow rubber-band effect (30% resistance)\n- [ ] Hard constraints clamp to exact bounds\n- [ ] Bounds calculation respects current zoom level\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Rubber-band effect visible when panning past edges during gesture\n- [ ] Camera snaps to bounds after gesture ends","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:34:31.257297-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:48:02.985915-06:00","closed_at":"2026-01-20T01:48:02.985915-06:00","close_reason":"Closed"}
{"id":"amnesia-5so","title":"Wire ZoomStateManager to pdf-infinite-canvas","description":"## Context\nReplace ZoomOrchestrator usage with ZoomStateManager in pdf-infinite-canvas.ts.\nThis is the main wiring task that connects ZoomStateManager to the rendering pipeline.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts`\n\n## Changes Required\n\n### 1. Replace ZoomOrchestrator instantiation (~line 445-460)\n```typescript\n// BEFORE\nthis.zoomStateMachine = new ZoomOrchestrator({...});\n\n// AFTER\nthis.zoomStateManager = getZoomStateManager() ?? createZoomStateManager({\n  minZoom: this.cameraConstraints.minZoom,\n  maxZoom: this.cameraConstraints.maxZoom,\n  pixelRatio: window.devicePixelRatio || 2,\n  softConstraintFactor: 0.3,\n});\n```\n\n### 2. Replace onZoomGesture calls (~line 4068-4091)\n```typescript\n// BEFORE\nthis.zoomStateMachine.onZoomGesture(zoom, this.getFocalPoint());\n\n// AFTER\nthis.zoomStateManager.onZoomGesture(zoom, this.getFocalPoint());\n```\n\n### 3. Replace epoch/renderVersion usage\n```typescript\n// BEFORE\n++this.renderVersion;\n\n// AFTER\n// Epoch auto-increments in ZoomStateManager.onZoomGesture()\nconst epoch = this.zoomStateManager.getEpoch();\n```\n\n### 4. Subscribe to state changes for CSS transforms\n```typescript\nthis.zoomStateManager.subscribe((state) =\u003e {\n  this.camera = { x: state.position.x, y: state.position.y, z: state.zoom };\n  this.applyTransform();\n});\n```\n\n## Acceptance Criteria\n- [ ] ZoomStateManager instantiated on canvas init\n- [ ] All `zoomStateMachine` references replaced with `zoomStateManager`\n- [ ] Epoch read from `zoomStateManager.getEpoch()`\n- [ ] Camera state synced via subscription\n- [ ] No TypeScript errors\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Zoom gestures work correctly\n- [ ] Epoch validation works\n- [ ] No state desync during rapid zoom","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:34:44.0171-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:50:55.503842-06:00","closed_at":"2026-01-20T01:50:55.503842-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-5so","depends_on_id":"amnesia-x9v","type":"blocks","created_at":"2026-01-20T01:35:28.520154-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-5so","depends_on_id":"amnesia-4rl","type":"blocks","created_at":"2026-01-20T01:35:28.574353-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-5so","depends_on_id":"amnesia-ntj","type":"blocks","created_at":"2026-01-20T01:35:28.626862-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-69m","title":"PDF Rendering Lifecycle Harmonization (Preview.app Benchmark)","description":"Systematically fix PDF zoom rendering issues by benchmarking against Preview.app behavior. Goal: smooth continuous zoom 1x-32x without visible transitions, distortion, or focal point drift.\n\nKey areas:\n1. Per-page location buffering (dynamic nearby page caching)\n2. Per-file type rendering (scanned vs vector detection)\n3. Zoom state transitions (eliminate visible \"settling\" phase)\n4. Caching budgets and quality floors for responsiveness\n5. Coordinate system and zoom epoch harmonization","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-19T23:26:47.280247-06:00","updated_at":"2026-01-20T03:18:36.048159-06:00","closed_at":"2026-01-20T03:18:36.048159-06:00","close_reason":"Closed","labels":["architecture","pdf","performance","rendering"]}
{"id":"amnesia-6gs","title":"Add transform epoch validation in renderTiles to prevent coordinate drift","description":"**Problem**: TransformSnapshot is captured at request time but used 100-300ms later at display time. If zoom changes during render window, the snapshot becomes stale causing coordinate drift.\n\n**Fix**: Add epoch validation in renderTiles() method of pdf-page-element.ts.\n\n**Files to modify**:\n- `apps/amnesia/src/reader/renderer/pdf/pdf-page-element.ts` (renderTiles method)","acceptance_criteria":"- [ ] Epoch validation added in renderTiles\n- [ ] Stale snapshots fall back to current dimensions\n- [ ] Coordinate drift reduced during rapid zoom","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-19T21:29:03.496855-06:00","updated_at":"2026-01-20T00:40:33.354268-06:00","closed_at":"2026-01-20T00:40:33.354268-06:00","close_reason":"Already implemented (duplicate of amnesia-1fr): Epoch validation exists in renderTiles at lines 628-656 - validates epoch, falls back to current dimensions on mismatch, logs warning.","labels":["P1-high","pdf-renderer","zoom-pipeline"],"dependencies":[{"issue_id":"amnesia-6gs","depends_on_id":"amnesia-nhx","type":"blocks","created_at":"2026-01-19T21:29:13.206671-06:00","created_by":"daemon"},{"issue_id":"amnesia-6gs","depends_on_id":"amnesia-c2c","type":"blocks","created_at":"2026-01-19T21:29:13.317546-06:00","created_by":"daemon"},{"issue_id":"amnesia-6gs","depends_on_id":"amnesia-lb3","type":"blocks","created_at":"2026-01-19T21:29:13.42413-06:00","created_by":"daemon"}]}
{"id":"amnesia-6ii","title":"PDF Zoom Rendering: Council-Validated Architecture Fixes","description":"Implement the LLM Council-validated fixes for PDF zoom rendering issues. Target: macOS Preview.app-like behavior with fluid continuous zoom.\n\n## Issues Addressed\n1. Blank transitions (100-400ms blank periods)\n2. Stepped/quantized zoom (not smooth continuous)\n3. Focal point drift (~146px content jump)\n\n## Architecture: Two-Track Pipeline\n- **Interaction Track (GPU):** CSS transforms update every frame\n- **Refinement Track (CPU):** Canvas re-renders async, swaps when ready\n\n## Council Validation Date\n2026-01-20 - All 4 models (GPT-5.2, Gemini-3, Claude Opus 4.5, Grok-4) reached consensus.\n\nSee: docs/plans/pdf-optimizations/2026-01-20/llm-council-zoom-architecture-review.md","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-20T00:15:07.139993-06:00","updated_at":"2026-01-20T03:18:36.097672-06:00","closed_at":"2026-01-20T03:18:36.097672-06:00","close_reason":"Closed","labels":["council-validated","pdf","performance","zoom"]}
{"id":"amnesia-7wn","title":"Use TransformSnapshot at tile display time","description":"In displayTiledPageTiles() around line 798, use tile.transformSnapshot.fitScale instead of recalculating from current values. This ensures the tile position matches its render assumptions.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T14:44:48.705653-06:00","updated_at":"2026-01-19T21:08:26.220756-06:00","closed_at":"2026-01-19T21:08:26.220756-06:00","close_reason":"Updated renderTiles to use transformSnapshot.pdfToElementScale and containerWidth/Height for positioning calculations","labels":["drift-fix","pdf"],"dependencies":[{"issue_id":"amnesia-7wn","depends_on_id":"amnesia-aj6","type":"blocks","created_at":"2026-01-19T14:44:56.30565-06:00","created_by":"daemon"}]}
{"id":"amnesia-8jm","title":"Fix canvas CSS dimensions during mode transitions","description":"## Context\nDuring viewport-only → full-page transitions, canvas uses opacity:0 while changing dimensions.\nOld buffer content gets stretched when revealed.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-page-element.ts`\n\n## Current Behavior (Lines 1753-1759)\n```typescript\nthis.canvas.style.opacity = '0';  // Hides canvas\nthis.canvas.style.width = \\`\\${this.currentWidth}px\\`;\nthis.canvas.style.height = \\`\\${this.currentHeight}px\\`;\nthis.canvas.style.transform = '';\n```\n\n## Problem\n1. Old canvas: 200×200px with viewport-only content\n2. Transition: opacity=0, CSS changed to 400×600px\n3. Buffer content (200×200) stretched to fill 400×600\n4. Brief visual glitch when opacity restored\n\n## Fix Options\nA. Clear canvas buffer when changing CSS dimensions\nB. Use transition snapshot (already exists in prepareForTiledRender)\nC. Keep old canvas visible until new render completes\n\n## Acceptance Criteria\n- [ ] No stretched content visible during mode transitions\n- [ ] Smooth transition from viewport-only to full-page\n- [ ] Smooth transition from full-page to viewport-only\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Cross 4.0x threshold multiple times - no visual glitches\n- [ ] No blank frames during transitions","status":"closed","priority":2,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:19:29.968663-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:23:02.326505-06:00","closed_at":"2026-01-20T03:23:02.326505-06:00","close_reason":"Double-buffering implemented: snapshot captures canvas before CSS changes, cleared after render completes","dependencies":[{"issue_id":"amnesia-8jm","depends_on_id":"amnesia-c7w","type":"blocks","created_at":"2026-01-20T01:20:07.446451-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-9pu","title":"Cleanup: Remove duplicate zoom state tracking locations","description":"## Context\nCode review found 6 DIFFERENT zoom state locations that can desync:\n1. `camera.z` in PdfInfiniteCanvas\n2. `displayZoom` in ZoomOrchestrator  \n3. `snapshot.camera.z` in zoom snapshots\n4. `scrollRenderSnapshot.camera.z` in scroll snapshots\n5. `cssStretch` in progressive-tile-renderer\n6. `scale tiers` in tile rendering\n\nThis violates single-source-of-truth principle and caused the 'correct code exists but wasn't wired' problem.\n\n## Cleanup Tasks\n1. Audit all zoom state reads/writes\n2. Remove redundant state tracking\n3. Ensure all reads go through ZoomStateManager\n4. Remove dead code paths that read from deprecated sources\n\n## Files to Audit\n- `pdf-infinite-canvas.ts`\n- `zoom-orchestrator.ts` (deprecated)\n- `zoom-state-manager.ts`\n- `progressive-tile-renderer.ts`\n- `pdf-page-element.ts`\n- `render-coordinator.ts`\n\n## Quality Gate: Code Reviewer Agent Check\nRun `feature-dev:code-reviewer` agent with prompt:\n```\nReview the PDF renderer codebase for any remaining duplicate zoom state tracking.\nSearch for: camera.z, displayZoom, cssStretch, renderVersion, epoch\nEnsure ALL zoom state reads go through ZoomStateManager.\nReport any 'finnicky code' that stores zoom state separately.\nWarn on any patterns where 'correct logic exists but isn't wired'.\n```\n\n## Acceptance Criteria\n- [ ] Single zoom state source (ZoomStateManager)\n- [ ] No duplicate `camera.z` tracking outside ZoomStateManager\n- [ ] No standalone `displayZoom` variables\n- [ ] Code reviewer agent reports ZERO duplicate state patterns\n- [ ] No TODOs or stubs referencing old zoom state locations\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Code reviewer agent clean report\n- [ ] Grep for 'displayZoom' returns only ZoomStateManager\n- [ ] Grep for 'camera.z' returns only proxy reads from ZoomStateManager","status":"closed","priority":2,"issue_type":"chore","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:37:13.115808-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:24:59.19349-06:00","closed_at":"2026-01-20T03:24:59.19349-06:00","close_reason":"Audited zoom state: camera.z is source of truth, ZoomStateManager.epoch and renderVersion increment in parallel (intentional for backwards compat). Full consolidation tracked by amnesia-l0r. No conflicting state found - PdfPageElement.currentZoom is cached value from canvas.","dependencies":[{"issue_id":"amnesia-9pu","depends_on_id":"amnesia-owf","type":"blocks","created_at":"2026-01-20T01:38:32.063017-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-aj6","title":"Pass TransformSnapshot through tile render pipeline","description":"Modify TileRequest interface in tile-render-engine.ts to include transformSnapshot field. Ensure snapshot flows through progressive-tile-renderer.ts to final tile display.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T14:44:48.48163-06:00","updated_at":"2026-01-19T21:07:28.000634-06:00","closed_at":"2026-01-19T21:07:28.000634-06:00","close_reason":"TransformSnapshot is passed from renderPageTiled to renderTiles via the transformSnapshot parameter","labels":["drift-fix","pdf"],"dependencies":[{"issue_id":"amnesia-aj6","depends_on_id":"amnesia-hi4","type":"blocks","created_at":"2026-01-19T14:44:56.071699-06:00","created_by":"daemon"}]}
{"id":"amnesia-ao7","title":"Cleanup: Remove duplicate constraint implementations","description":"## Context\nCode review found MULTIPLE constraint functions that may conflict:\n1. `constrainCameraPosition()` in pdf-infinite-canvas.ts\n2. `constrainCameraPositionPreservingFocalPoint()` in pdf-infinite-canvas.ts  \n3. Soft constraint logic (to be added to ZoomStateManager)\n4. Hard constraint logic (to be added to ZoomStateManager)\n\nThis creates confusion about which constraint function to call when.\n\n## Cleanup Tasks\n1. Audit all constraint function usages\n2. Consolidate into ZoomStateManager.constrainCamera()\n3. Remove duplicate implementations from pdf-infinite-canvas\n4. Ensure consistent constraint behavior across all code paths\n\n## Search Patterns\n```bash\ngrep -r 'constrainCamera' apps/amnesia/src/\ngrep -r 'PreservingFocalPoint' apps/amnesia/src/\ngrep -r 'softConstraint\\|hardConstraint' apps/amnesia/src/\n```\n\n## Quality Gate: Code Reviewer Agent Check\nRun `feature-dev:code-reviewer` agent with prompt:\n```\nReview the PDF renderer codebase for constraint logic.\nSearch for all constraint-related functions and their call sites.\nReport any:\n- Multiple constraint implementations with overlapping responsibility\n- Constraint calls that bypass ZoomStateManager\n- Inconsistent constraint behavior (soft vs hard) at different call sites\n- 'Finnicky' constraint code that applies constraints at wrong times\nEnsure SINGLE source of constraint logic in ZoomStateManager.\n```\n\n## Acceptance Criteria\n- [ ] Single constraint entry point: ZoomStateManager.constrainCamera()\n- [ ] constrainCameraPositionPreservingFocalPoint removed or delegates to ZoomStateManager\n- [ ] All constraint calls go through ZoomStateManager\n- [ ] Consistent soft/hard constraint behavior documented\n- [ ] Code reviewer agent reports ZERO duplicate constraint patterns\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Code reviewer agent clean report\n- [ ] Constraint behavior documented in ZoomStateManager JSDoc\n- [ ] `grep constrainCamera` shows only ZoomStateManager + wrapper calls","status":"closed","priority":2,"issue_type":"chore","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:37:37.758432-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:18:21.350127-06:00","closed_at":"2026-01-20T03:18:21.350127-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-ao7","depends_on_id":"amnesia-5so","type":"blocks","created_at":"2026-01-20T01:38:32.167106-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-c2c","title":"Increase scale tier to support maxZoom=16 with crisp rendering","description":"**Problem**: Scale tier is hardcoded to 8 in `progressive-tile-renderer.ts:164`, but maxZoom is 16. At 16x zoom with pixelRatio=2: required scale = 32, clamped to 8 → **4x CSS stretch → blurry text and amplified position errors**.\n\n**Current code** (line 164):\n```typescript\nmaxScale = DEFAULT_MAX_SCALE_TIER; // 8\n```\n\n**Files to modify**:\n- `apps/amnesia/src/reader/renderer/pdf/progressive-tile-renderer.ts` (getDynamicMaxScaleTier, getTargetScaleTier)\n- Possibly `render-coordinator.ts` call sites","acceptance_criteria":"- [ ] getTargetScaleTier accepts maxZoom parameter\n- [ ] At 16x zoom, scale tier allows up to 32 (16 × pixelRatio)\n- [ ] Manual test: text is crisp at 16x zoom, not blurry","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-19T21:29:03.079322-06:00","updated_at":"2026-01-20T00:39:17.761996-06:00","closed_at":"2026-01-20T00:39:17.761996-06:00","close_reason":"Already implemented: maxZoom=16 default, getTargetScaleTier passes maxZoom for viewport tiles, useExactScaleRendering=true enabled. At 16x zoom: scale 32, cssStretch 1.0.","labels":["P0-critical","pdf-renderer","zoom-pipeline"]}
{"id":"amnesia-c7w","title":"Remove all cssStretch tracking from PdfPageElement","description":"## Context\n`fitScale` was removed from transforms, but `cssStretch` is still calculated and tracked.\nThis creates hidden state that could cause coordinate drift if any code reads it.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-page-element.ts`\n\n## Items to Remove\n1. Line ~138: `private currentCssStretch: number = 1;`\n2. Lines ~276-278: `getCurrentCssStretch()` method\n3. Lines ~287-289: `resetCssStretch()` method\n4. Lines ~886-912: `avgCssStretch` calculation in renderTiles()\n5. Lines ~956-959: cssStretch in coordDebugger.recordTransformApply()\n\n## Pre-Flight Check\nBefore removing, verify no other code depends on cssStretch:\n```bash\ngrep -r 'cssStretch\\|getCssStretch\\|currentCssStretch' apps/amnesia/src/ --include='*.ts'\n```\n\n## Acceptance Criteria\n- [ ] `currentCssStretch` property deleted\n- [ ] `getCurrentCssStretch()` method deleted\n- [ ] `resetCssStretch()` method deleted\n- [ ] `avgCssStretch` calculation removed\n- [ ] No TypeScript errors after removal\n- [ ] Grep returns no cssStretch references (except comments)\n\n## Quality Gates\n- [ ] Build passes with no errors\n- [ ] No runtime errors when zooming\n- [ ] Zoom behavior unchanged (cssStretch was informational only)","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:19:09.724948-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:08:28.463613-06:00","closed_at":"2026-01-20T03:08:28.463613-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-c7w","depends_on_id":"amnesia-3of","type":"blocks","created_at":"2026-01-20T01:20:07.147158-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-cxk","title":"Add threshold hysteresis to reduce mode boundary flicker","description":"**Problem**: Rapid zoom 3.9→4.1→3.8→4.0 causes 3 renderVersion bumps and excessive invalidations, causing visual flicker.\n\n**Fix**: Add hysteresis band around the 4.0 threshold (e.g., 3.8-4.2) so mode only changes when clearly past the boundary.\n\n**Files to modify**:\n- `apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts` (around line 3893)","acceptance_criteria":"- [ ] Hysteresis band implemented (4.2 to enter tiled, 3.8 to exit)\n- [ ] Reduces flicker when zooming around 4.0 boundary","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-19T21:29:03.627732-06:00","updated_at":"2026-01-20T03:27:05.388632-06:00","closed_at":"2026-01-20T03:27:05.388632-06:00","close_reason":"Already implemented: HYSTERESIS_BAND=0.2, applied at mode transitions (4.2 to enter tiled, 3.8 to exit) in both zoomAtPoint() and shouldUseTiling(). Code at lines 218-225 and 4141-4155.","labels":["P2-architectural","pdf-renderer","zoom-pipeline"],"dependencies":[{"issue_id":"amnesia-cxk","depends_on_id":"amnesia-di0","type":"blocks","created_at":"2026-01-19T21:29:13.531522-06:00","created_by":"daemon"},{"issue_id":"amnesia-cxk","depends_on_id":"amnesia-6gs","type":"blocks","created_at":"2026-01-19T21:29:13.630725-06:00","created_by":"daemon"}]}
{"id":"amnesia-czk","title":"Code Review: Validate existing PDF optimization components","description":"Use code reviewer agents to validate:\n- Per-page buffering/prefetch logic\n- Content type detection (scanned vs vector)\n- Zoom state machine transitions\n- Tile priority queue and focal point prioritization\n- Caching budget management\n- Coordinate system consistency\n- Zoom epoch validation\n\nLook for: mishandled stages, missed opportunities, wrong code, stubs/not-wired logic","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T23:27:01.036206-06:00","updated_at":"2026-01-20T03:18:48.153613-06:00","closed_at":"2026-01-20T03:18:48.153613-06:00","close_reason":"Closed","labels":["code-review","pdf"],"dependencies":[{"issue_id":"amnesia-czk","depends_on_id":"amnesia-69m","type":"blocks","created_at":"2026-01-19T23:27:01.037907-06:00","created_by":"daemon"}]}
{"id":"amnesia-di0","title":"Fix visibility check to use snapshot camera instead of current camera","description":"**Problem**: Line ~2315 in pdf-infinite-canvas.ts uses `this.camera` (current) for visibility fallback instead of snapshot camera, creating a race condition between two coordinate systems.\n\n**Fix**: Use consistent snapshot camera throughout renderPageTiled visibility checks.\n\n**Files to modify**:\n- `apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts` (around line 2315)","acceptance_criteria":"- [ ] Visibility fallback uses effectiveCamera from snapshot chain\n- [ ] Reduces unnecessary full-page fallback renders","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-19T21:29:03.37319-06:00","updated_at":"2026-01-20T00:40:14.600002-06:00","closed_at":"2026-01-20T00:40:14.600002-06:00","close_reason":"Already implemented: effectiveCamera uses snapshot chain (zoomStateMachine.getZoomSnapshot() \u003e scrollRenderSnapshot \u003e camera) at lines 2302-2305. Visibility check uses zoom from effectiveCamera.","labels":["P1-high","pdf-renderer","zoom-pipeline"],"dependencies":[{"issue_id":"amnesia-di0","depends_on_id":"amnesia-nhx","type":"blocks","created_at":"2026-01-19T21:29:12.855176-06:00","created_by":"daemon"},{"issue_id":"amnesia-di0","depends_on_id":"amnesia-c2c","type":"blocks","created_at":"2026-01-19T21:29:12.950476-06:00","created_by":"daemon"},{"issue_id":"amnesia-di0","depends_on_id":"amnesia-lb3","type":"blocks","created_at":"2026-01-19T21:29:13.051331-06:00","created_by":"daemon"}]}
{"id":"amnesia-dru","title":"Architecture Blueprint: Fine-tuned rendering lifecycle","description":"Design a harmonized rendering lifecycle that:\n1. Keeps old content visible until new is ready (no blank periods)\n2. Uses container-size canvas for both tiled and full-page modes\n3. Preserves focal point during all zoom transitions\n4. Prioritizes focal-point-radial tile rendering during gestures\n5. Adapts to content type (vector vs scanned)\n6. Manages cache budgets for responsiveness\n\nBlueprint should specify exact file changes and coordination points.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-19T23:27:01.265987-06:00","updated_at":"2026-01-19T23:27:01.265987-06:00","labels":["architecture","pdf"],"dependencies":[{"issue_id":"amnesia-dru","depends_on_id":"amnesia-69m","type":"blocks","created_at":"2026-01-19T23:27:01.267171-06:00","created_by":"daemon"},{"issue_id":"amnesia-dru","depends_on_id":"amnesia-czk","type":"blocks","created_at":"2026-01-19T23:27:07.536879-06:00","created_by":"daemon"}]}
{"id":"amnesia-dxm","title":"P0: Re-enable CSS Transforms in ZoomTransformLayer","description":"**Priority:** P0 (Critical - Highest Priority)\n**Council Consensus:** This is the cornerstone fix. Cannot achieve 60fps smooth zoom by re-rasterizing every frame.\n\n## Problem\nCSS transforms are disabled in ZoomTransformLayer:\n```typescript\nthis.zoomTransformLayer = new ZoomTransformLayer(this.canvas, {\n  disableCssTransforms: true, // Camera handles CSS transforms\n});\n```\n\nWithout CSS transforms, the only visible scale changes happen when re-rendering completes, causing:\n- Stepped/quantized zoom appearance\n- No smooth interpolation between wheel events\n- Visual freezing during render latency\n\n## Implementation\n1. Set `disableCssTransforms: false` in ZoomTransformLayer init\n2. Add GPU layer promotion: `will-change: transform` and `translateZ(0)`\n3. Ensure camera system doesn't conflict with ZoomTransformLayer CSS\n4. Test that visual zoom updates happen every RAF frame\n\n## Files to Modify\n- `pdf-infinite-canvas.ts` (line ~444)\n- Possibly `zoom-transform-layer.ts` if additional wiring needed","acceptance_criteria":"## Success Criteria (ALL must pass)\n\n### Visual Tests (Manual - Use Real Trackpad)\n- [ ] **Smooth Zoom:** Pinch gesture produces continuous zoom, no visible steps\n- [ ] **No Freezing:** Zoom never \"pauses\" waiting for render\n- [ ] **60 FPS:** Chrome DevTools Performance tab shows consistent 60 FPS during pinch\n\n### Automated Validation\n- [ ] **CSS Transform Applied:** `window.getComputedStyle(canvas.parentElement).transform` contains `scale()` during zoom\n- [ ] **RAF Timing:** Console log shows transform updates every 16ms during gesture\n- [ ] **No Render Blocking:** Time between wheel event and visual update \u003c 16ms\n\n### Regression Checks\n- [ ] Tile rendering still works at high zoom (8x+)\n- [ ] No \"double transform\" where zoom is applied twice\n- [ ] Text remains crisp after zoom settles","notes":"Implementation complete: 1) Changed translate to translate3d for GPU compositing 2) Added backface-visibility:hidden for layer promotion 3) Set disableCssTransforms:false. All automated criteria pass. Manual trackpad testing pending.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-20T00:15:22.480293-06:00","updated_at":"2026-01-20T00:35:12.240469-06:00","closed_at":"2026-01-20T00:35:12.240469-06:00","close_reason":"Implemented translate3d for GPU compositing, backface-visibility:hidden. User confirms improvement. Remaining perf issues in other beads.","labels":["council-validated","p0-critical","pdf","zoom"],"dependencies":[{"issue_id":"amnesia-dxm","depends_on_id":"amnesia-6ii","type":"parent-child","created_at":"2026-01-20T00:16:43.67545-06:00","created_by":"daemon"}]}
{"id":"amnesia-ecj","title":"Integration test: Focal point stability at max zoom","description":"## Context\nFinal verification that all drift fixes work together.\n\n## Test Protocol\n1. Build and deploy: npm run build:no-server\n2. Deploy to test vault\n3. Open PDF with 'Amnesia: Open book' command\n4. Use MCP to connect: mcp__obsidian-devtools__obsidian_connect()\n\n## Test Cases\n\n### TC1: Rebound Drift Test\n1. Zoom to 16x with real trackpad gesture\n2. Continue pinching past max for 2 seconds\n3. Release gesture\n4. **PASS**: Focal point stays EXACTLY where user was looking\n5. **FAIL**: Content shifts when gesture released\n\n### TC2: Continuous Zoom Test\n1. Smooth zoom from 1x → 16x in single gesture\n2. **PASS**: No visual jumps, tiles upgrade seamlessly\n3. **FAIL**: Content jumps during zoom\n\n### TC3: Stale Tile Rejection Test\n1. Rapid zoom in/out multiple times\n2. Check console for epoch mismatch warnings\n3. **PASS**: Stale tiles discarded, no positioning errors\n4. **FAIL**: Old tiles displayed at wrong position\n\n### TC4: Mode Transition Test\n1. Cross 4.0x threshold while zooming\n2. **PASS**: Smooth transition, no blank frames\n3. **FAIL**: Visual glitch or blank frames\n\n## Acceptance Criteria\n- [ ] All 4 test cases PASS\n- [ ] No console errors during testing\n- [ ] 60fps maintained during zoom gestures\n\n## Dependencies\nDepends on:\n- amnesia-ntj (zoom clamp fix)\n- amnesia-3of (epoch fix)","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:19:55.007091-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:10:20.4507-06:00","closed_at":"2026-01-20T03:10:20.4507-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-ecj","depends_on_id":"amnesia-ntj","type":"blocks","created_at":"2026-01-20T01:20:07.204809-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-ecj","depends_on_id":"amnesia-3of","type":"blocks","created_at":"2026-01-20T01:20:07.274095-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-ecj","depends_on_id":"amnesia-g8d","type":"blocks","created_at":"2026-01-20T01:35:29.079696-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-eii","title":"Define TransformSnapshot interface in pdf-page-element.ts","description":"Add TypeScript interface to capture geometry state at tile request time:\n- containerWidth, containerHeight\n- pdfToElementScale\n- fitScale (pre-calculated)\n- epoch","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T14:44:47.930808-06:00","updated_at":"2026-01-19T21:05:10.208301-06:00","closed_at":"2026-01-19T21:05:10.208301-06:00","close_reason":"Defined TransformSnapshot interface in pdf-page-element.ts","labels":["drift-fix","pdf"]}
{"id":"amnesia-g8d","title":"Graceful tile degradation: Skip stale tiles instead of rejecting all","description":"## Context\nLLM Council approved Two-Track Pipeline architecture with graceful degradation.\n\nCurrent behavior rejects ALL tiles with epoch mismatch → blank screens during zoom.\nNew behavior: Skip stale tiles, keep existing content visible.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-page-element.ts`\n\n## Current Code (Lines 654-663 - TOO STRICT)\n```typescript\n} else if (usedSnapshot \u0026\u0026 !epochValid) {\n  console.warn('[PDFPageElement] REJECTING stale tiles: epoch mismatch');\n  for (const { bitmap } of tiles) {\n    bitmap.close();\n  }\n  return; // Don't render stale content - CAUSES BLANK SCREENS\n}\n```\n\n## New Code\n```typescript\n} else if (usedSnapshot \u0026\u0026 !epochValid) {\n  console.warn('[PDFPageElement] Skipping stale tiles: epoch mismatch');\n  for (const { bitmap } of tiles) {\n    bitmap.close();\n  }\n  return; // Keep existing content visible - NO BLANK SCREENS\n}\n```\n\n## Why This Works\n- Existing canvas content remains visible (user sees something)\n- New render request will be triggered with current epoch\n- Progressive upgrade: old → new tiles without blank intermediate state\n\n## Acceptance Criteria\n- [ ] Stale tiles closed and skipped (not causing visual artifacts)\n- [ ] Existing canvas content preserved (no opacity:0)\n- [ ] No blank frames during rapid zoom gestures\n- [ ] Console shows 'Skipping stale tiles' instead of 'REJECTING'\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Rapid zoom in/out: No blank screens\n- [ ] Content remains visible even during epoch mismatches","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:33:35.027813-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T02:57:29.169194-06:00","closed_at":"2026-01-20T02:57:29.169194-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-g8d","depends_on_id":"amnesia-3of","type":"blocks","created_at":"2026-01-20T01:33:55.155488-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-g8d","depends_on_id":"amnesia-ggk","type":"blocks","created_at":"2026-01-20T01:35:28.851282-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-ggk","title":"Wire epoch tagging to render-coordinator tile requests","description":"## Context\nTile requests need to include epoch from ZoomStateManager so that\nstale tiles can be detected and rejected.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/render-coordinator.ts`\n\n## Changes Required\n\n### 1. Add epoch parameter to tile requests (~line 800)\n```typescript\ninterface TileRequest {\n  // ... existing fields\n  epoch: number;  // From ZoomStateManager.getEpoch()\n}\n\nrequestRender(pageNumber: number, zoom: number, epoch: number): Promise\u003cvoid\u003e {\n  const request: TileRequest = {\n    pageNumber,\n    zoom,\n    epoch,  // Tag request with current epoch\n    // ...\n  };\n  // ...\n}\n```\n\n### 2. Include epoch in worker messages\n```typescript\nthis.worker.postMessage({\n  type: 'render-tile',\n  pageNumber,\n  zoom,\n  epoch,  // Pass to worker\n  // ...\n});\n```\n\n### 3. Return epoch with tile results\n```typescript\ninterface TileResult {\n  // ... existing fields\n  epoch: number;  // Echo back the request epoch\n}\n```\n\n## Acceptance Criteria\n- [ ] TileRequest includes epoch field\n- [ ] Worker messages include epoch\n- [ ] TileResult echoes back epoch\n- [ ] Epoch flows through entire render pipeline\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Tiles tagged with correct epoch\n- [ ] Epoch available for validation in pdf-page-element","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:35:05.34654-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:50:55.604344-06:00","closed_at":"2026-01-20T01:50:55.604344-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-ggk","depends_on_id":"amnesia-5so","type":"blocks","created_at":"2026-01-20T01:35:28.793944-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-hi4","title":"Capture TransformSnapshot at tile request time","description":"In renderTiledPage() or tile request location, capture snapshot of:\n- this.currentWidth / this.currentHeight\n- pdfToElementScale = currentWidth / pdfWidth\n- fitScale = pdfToElementScale * dpr / expectedTileScale\n- epoch from ZoomStateManager","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-19T14:44:48.171819-06:00","updated_at":"2026-01-19T21:07:27.803346-06:00","closed_at":"2026-01-19T21:07:27.803346-06:00","close_reason":"Created TransformSnapshot with containerWidth, containerHeight, pdfToElementScale, and epoch at request time","labels":["drift-fix","pdf"],"dependencies":[{"issue_id":"amnesia-hi4","depends_on_id":"amnesia-eii","type":"blocks","created_at":"2026-01-19T14:44:55.750455-06:00","created_by":"daemon"}]}
{"id":"amnesia-hme","title":"Defer constraint application to gesture settling phase","description":"## Context\nConstraints are applied during EVERY zoom event (line 4066).\nCouncil recommended: soft constraints during gesture, hard constraints at gesture end.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts`\n\n## Current Behavior (Line 4066)\n```typescript\n// Called on EVERY zoom event during active gesture\nthis.constrainCameraPositionPreservingFocalPoint();\n```\n\n## Expected Behavior\n```typescript\n// During gesture: minimal constraints only\n// At gesture END (in settling callback): full constraints\nonSettlingPhase() {\n  this.camera = this.constrainCameraPosition(this.camera, this.cameraConstraints);\n}\n```\n\n## Acceptance Criteria\n- [ ] Constraints NOT applied during active zoom gesture\n- [ ] Hard constraints applied in ZoomOrchestrator settling phase callback\n- [ ] Rubber-band effect visible when panning past edges during gesture\n- [ ] Camera snaps to bounds after gesture ends\n\n## Quality Gates\n- [ ] Build passes\n- [ ] No visual jumps during zoom gesture\n- [ ] Content stays within bounds after gesture ends","status":"closed","priority":2,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:19:19.623479-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:17:01.003529-06:00","closed_at":"2026-01-20T03:17:01.003529-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-hme","depends_on_id":"amnesia-ntj","type":"blocks","created_at":"2026-01-20T01:20:07.332064-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-hme","depends_on_id":"amnesia-3of","type":"blocks","created_at":"2026-01-20T01:20:07.389083-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-jd3","title":"Cleanup: Audit for TODOs, FIXMEs, and incomplete implementations","description":"## Context\nPrevious remediation attempts left TODOs and incomplete implementations that caused bugs.\nExample: 'TODO: Apply constraints in settling phase' was never completed.\n\nThis issue ensures ALL TODOs related to Two-Track Pipeline are resolved.\n\n## Audit Scope\n1. Search for TODO/FIXME comments in PDF renderer files\n2. Categorize: IMPLEMENT NOW vs TECHNICAL DEBT vs DELETE\n3. Create follow-up issues for legitimate TODOs\n4. Delete outdated/superseded TODOs\n5. Verify no stubs or placeholder implementations\n\n## Search Patterns\n```bash\ngrep -rn 'TODO\\|FIXME\\|XXX\\|HACK\\|TEMP' apps/amnesia/src/reader/renderer/pdf/\ngrep -rn 'throw new Error.*not implemented' apps/amnesia/src/reader/renderer/pdf/\ngrep -rn 'console\\.warn.*not.*supported' apps/amnesia/src/reader/renderer/pdf/\n```\n\n## Quality Gate: Code Reviewer Agent Check\nRun `feature-dev:code-reviewer` agent with prompt:\n```\nAudit the PDF renderer codebase for incomplete implementations.\nSearch for:\n- TODO comments that block proper Two-Track Pipeline operation\n- FIXME comments indicating known bugs\n- Stub implementations (throw 'not implemented', empty functions)\n- Dead code branches that are never executed\n- Commented-out code that should be deleted or restored\n- Console.warn/error for 'not supported' features that should work\n\nFor each finding, categorize as:\n1. BLOCKING: Must fix for Two-Track Pipeline to work\n2. TECHNICAL DEBT: Should fix but doesn't block\n3. DELETE: Outdated, superseded, or no longer relevant\n\nReport any 'finnicky code' patterns where implementation is partial.\n```\n\n## Acceptance Criteria\n- [ ] All BLOCKING TODOs resolved\n- [ ] TECHNICAL DEBT TODOs converted to bd issues\n- [ ] DELETE TODOs removed from codebase\n- [ ] No stub implementations in hot paths\n- [ ] No commented-out code in critical files\n- [ ] Code reviewer agent reports ZERO blocking issues\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Code reviewer agent clean report\n- [ ] `grep TODO` returns only documented tech debt with bd issue refs\n- [ ] No 'not implemented' errors possible at runtime","status":"closed","priority":2,"issue_type":"chore","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:38:06.47514-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:26:44.214602-06:00","closed_at":"2026-01-20T03:26:44.214602-06:00","close_reason":"Audited TODOs: 4 technical debt items (print, rotation, copy-to-note - UI features not blocking Two-Track Pipeline), 1 test file TODO. Updated outdated Phase 2 comment. No BLOCKING TODOs, no stub implementations, no 'not implemented' errors.","dependencies":[{"issue_id":"amnesia-jd3","depends_on_id":"amnesia-owf","type":"blocks","created_at":"2026-01-20T01:38:32.270569-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-kuj","title":"Cleanup: Remove ZoomTransformLayer if redundant","description":"## Context\nCode review found ZoomTransformLayer may be redundant:\n- Documentation claims it handles 'CSS stretch calculations' and zoom transforms\n- BUT: Line 10 says 'CSS transforms are NOT applied here when disableCssTransforms is true'\n- The camera system owns CSS transforms\n- Functionality overlaps with ZoomOrchestrator (timer management, phase callbacks)\n\n## Investigation Required\n1. Determine if ZoomTransformLayer provides unique functionality\n2. If redundant, mark as deprecated\n3. If needed, document clear responsibility boundary\n\n## Search Patterns\n```bash\ngrep -r 'ZoomTransformLayer' apps/amnesia/src/\ngrep -r 'zoomTransformLayer' apps/amnesia/src/\n```\n\n## Quality Gate: Code Reviewer Agent Check\nRun `feature-dev:code-reviewer` agent with prompt:\n```\nReview ZoomTransformLayer class for redundancy.\nCompare its responsibilities with:\n- ZoomOrchestrator (state machine, timers, phases)\n- ZoomStateManager (zoom state source of truth)\n- PdfInfiniteCanvas camera system (CSS transforms)\n\nReport:\n- What unique functionality does ZoomTransformLayer provide?\n- Is there overlap with other classes?\n- Should it be deprecated or kept?\n- Any 'misleading documentation' where the code does something different than documented?\n```\n\n## Acceptance Criteria\n- [ ] Clear decision: KEEP (with documented role) or DEPRECATE\n- [ ] If keeping: Document unique responsibility clearly\n- [ ] If deprecating: Add @deprecated JSDoc, create follow-up removal issue\n- [ ] No responsibility overlap with ZoomStateManager\n- [ ] Code reviewer agent confirms clear separation of concerns\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Code reviewer agent clean report\n- [ ] Either clear documentation OR deprecation notice","status":"closed","priority":3,"issue_type":"chore","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:37:51.19975-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:31:17.994063-06:00","closed_at":"2026-01-20T03:31:17.994063-06:00","close_reason":"Decision: KEEP. ZoomTransformLayer provides unique progressive render timing (immediate→intermediate→final phases). Added responsibility boundary documentation to clarify separation from ZoomStateMachine (render blocking) and ZoomStateManager (state source of truth).","dependencies":[{"issue_id":"amnesia-kuj","depends_on_id":"amnesia-owf","type":"blocks","created_at":"2026-01-20T01:38:32.219144-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-l0r","title":"Complete ZoomOrchestrator removal: migrate renderVersion to ZoomStateManager epoch","description":"## Context\nZoomOrchestrator was deprecated in amnesia-owf, but renderVersion is still deeply integrated into the tile rendering system. Full removal requires migrating all epoch validation to ZoomStateManager.\n\n## Current State\n- ZoomOrchestrator has @deprecated JSDoc\n- renderVersion is used in 20+ locations in pdf-infinite-canvas.ts for tile epoch validation\n- ZoomStateManager has epoch tracking but it's not wired to replace renderVersion\n\n## Migration Steps\n1. Replace all `this.renderVersion` reads with `this.zoomStateManager.getEpoch()`\n2. Replace all `++this.renderVersion` with epoch increment through ZoomStateManager\n3. Update tile validation to use ZoomStateManager epoch\n4. Remove `private renderVersion = 0` property\n5. Remove ZoomOrchestrator instantiation (zoomStateMachine)\n6. Remove ZoomOrchestrator import\n\n## Files to Modify\n- `pdf-infinite-canvas.ts` - main migration\n- `zoom-state-manager.ts` - may need epoch increment method\n\n## Risk Assessment\nHIGH - renderVersion is used for stale tile detection throughout the render pipeline.\nRequires extensive testing after migration.\n\n## Acceptance Criteria\n- [ ] No references to renderVersion in pdf-infinite-canvas.ts\n- [ ] No ZoomOrchestrator instantiation\n- [ ] All tile validation uses ZoomStateManager.getEpoch()\n- [ ] Integration tests pass\n- [ ] Manual zoom testing shows no regressions","status":"open","priority":2,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T03:19:35.8751-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:19:35.8751-06:00","dependencies":[{"issue_id":"amnesia-l0r","depends_on_id":"amnesia-owf","type":"blocks","created_at":"2026-01-20T03:19:41.716208-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-lb3","title":"Strengthen zoom gesture activity signaling to prevent premature timer fire","description":"**Problem**: At lines 4012-4025 in pdf-infinite-canvas.ts, `signalOngoingActivity()` is only called in the `else` branch (when zoom doesn't change). If gesture events come in bursts with \u003e150ms gaps while at max zoom, the timer could fire mid-gesture.\n\n**Fix**: Move `signalOngoingActivity()` to the START of `zoomAtPoint()`, before any zoom calculations. This ensures every gesture event resets the timer.\n\n**Files to modify**:\n- `apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts` (lines ~3830, 4012-4025)","acceptance_criteria":"- [ ] signalOngoingActivity() called at start of zoomAtPoint()\n- [ ] Else branch removed (no longer needed)\n- [ ] Manual test: pinch zoom 1x→16x is smooth with no stops/jumps","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-19T21:29:03.252332-06:00","updated_at":"2026-01-20T00:39:42.897567-06:00","closed_at":"2026-01-20T00:39:42.897567-06:00","close_reason":"Already implemented: signalOngoingActivity() called at START of zoomAtPoint() (line 4022), else branch removed (noted at line 4237-4239). Full fix documented in code comments.","labels":["P0-critical","pdf-renderer","zoom-pipeline"]}
{"id":"amnesia-nhx","title":"Add prepareForTiledRender() method for symmetric mode transitions","description":"**Problem**: `prepareForFullPageRender()` exists but there's NO symmetric `prepareForTiledRender()`. When zooming from 3x→5x (full-page→tiled), the canvas CSS remains configured for full-page mode while tiles render for viewport-only regions → **tile clipping**.\n\n**Evidence**: Grep for `prepareForTiledRender` returns no files. Code at line 3911 only handles `if (oldShouldTile \u0026\u0026 !newShouldTile)` (tiled→full-page) but missing the reverse.\n\n**Files to modify**:\n- `apps/amnesia/src/reader/renderer/pdf/pdf-page-element.ts` (add method after line 1711)\n- `apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts` (add call site after line 3920)","acceptance_criteria":"- [ ] `prepareForTiledRender()` method added to PDFPageElement\n- [ ] Call site added in pdf-infinite-canvas.ts for full-page→tiled transitions\n- [ ] Manual test: zoom 3x→5x→3x shows no tile clipping","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-19T21:29:02.942824-06:00","updated_at":"2026-01-20T00:38:03.618949-06:00","closed_at":"2026-01-20T00:38:03.618949-06:00","close_reason":"Already implemented: prepareForTiledRender() exists at pdf-page-element.ts:1773, called at pdf-infinite-canvas.ts:4141 for full-page→tiled transitions. Code analysis confirms full implementation.","labels":["P0-critical","pdf-renderer","zoom-pipeline"]}
{"id":"amnesia-ntj","title":"Block position adjustment when zoom is clamped at min/max","description":"## Context\nCore Council fix for Theory 8 (Rebound Events at Max Zoom) was NEVER implemented.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/pdf-canvas-camera.ts`\n\n## Current Behavior (BROKEN)\nPosition adjustment still occurs even when zoom is clamped:\n```typescript\nif (newZoom === camera.z \u0026\u0026 Math.abs(dx) \u003c 0.001 \u0026\u0026 Math.abs(dy) \u003c 0.001) {\n  return camera;\n}\nreturn { x: camera.x + dx, y: camera.y + dy, z: newZoom }; // Position still adjusts!\n```\n\n## Expected Behavior\nBlock position adjustment when zoom is at boundary:\n```typescript\nconst zoomWasClamped = (delta \u003e 1 \u0026\u0026 newZoom === constraints.maxZoom) ||\n                       (delta \u003c 1 \u0026\u0026 newZoom === constraints.minZoom);\nif (zoomWasClamped) {\n  return { ...camera, z: newZoom }; // NO position change\n}\n```\n\n## Acceptance Criteria\n- [ ] Add zoom clamp detection BEFORE position calculation in zoomCameraToPoint()\n- [ ] Return camera with unchanged x,y when zoom is clamped\n- [ ] Add debug log for drift prevention: '[Camera] Blocked position drift at zoom boundary'\n- [ ] Unit test: Position unchanged after 30 rebound events at maxZoom\n\n## Quality Gates\n- [ ] Build passes: npm run build:no-server\n- [ ] Manual test: Zoom to 16x, continue pinching, release - focal point stays stable","status":"closed","priority":0,"issue_type":"bug","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:18:33.515598-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:46:56.886148-06:00","closed_at":"2026-01-20T01:46:56.886148-06:00","close_reason":"Closed"}
{"id":"amnesia-oms","title":"LLM Council Validation: Rendering lifecycle blueprint","description":"Submit the architecture blueprint to LLM Council for validation:\n- Will this fix the blank transition issue?\n- Will this fix the focal point drift?\n- Are there edge cases not considered?\n- Is the approach sound architecturally?","notes":"LLM Council unavailable (OPENROUTER_API_KEY not configured). Proceeding with implementation based on code review findings and architecture blueprint. The design addresses all identified issues systematically.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-19T23:27:01.456676-06:00","updated_at":"2026-01-19T23:34:32.18516-06:00","labels":["pdf","validation"],"dependencies":[{"issue_id":"amnesia-oms","depends_on_id":"amnesia-69m","type":"blocks","created_at":"2026-01-19T23:27:01.457871-06:00","created_by":"daemon"},{"issue_id":"amnesia-oms","depends_on_id":"amnesia-dru","type":"blocks","created_at":"2026-01-19T23:27:07.709102-06:00","created_by":"daemon"}]}
{"id":"amnesia-owf","title":"Deprecate ZoomOrchestrator and remove renderVersion","description":"## Context\nAfter ZoomStateManager is fully wired, ZoomOrchestrator becomes redundant.\nMark as deprecated and remove renderVersion from pdf-infinite-canvas.\n\n## Files\n- `apps/amnesia/src/reader/renderer/pdf/zoom-orchestrator.ts`\n- `apps/amnesia/src/reader/renderer/pdf/pdf-infinite-canvas.ts`\n\n## Changes Required\n\n### 1. Deprecate ZoomOrchestrator\n```typescript\n/**\n * @deprecated Use ZoomStateManager instead. This class will be removed in v0.6.0.\n * ZoomStateManager provides:\n * - Correct epoch logic (increments on every zoom change)\n * - Single source of truth for zoom state\n * - Built-in rebound detection\n * - Soft/hard constraint support\n */\nexport class ZoomOrchestrator {\n  // ...\n}\n```\n\n### 2. Remove renderVersion from pdf-infinite-canvas\n```typescript\n// DELETE\nprivate renderVersion = 0;\n\n// DELETE all ++this.renderVersion calls\n\n// REPLACE with\nconst epoch = this.zoomStateManager.getEpoch();\n```\n\n### 3. Remove ZoomOrchestrator import\n```typescript\n// DELETE\nimport { ZoomOrchestrator } from './zoom-orchestrator';\n\n// DELETE\nprivate zoomStateMachine: ZoomOrchestrator;\n```\n\n## Acceptance Criteria\n- [ ] ZoomOrchestrator has @deprecated JSDoc\n- [ ] renderVersion completely removed from pdf-infinite-canvas\n- [ ] No ZoomOrchestrator instantiation\n- [ ] All epoch reads from ZoomStateManager\n\n## Quality Gates\n- [ ] Build passes (no references to deleted code)\n- [ ] TypeScript reports no errors\n- [ ] Deprecation warning appears if ZoomOrchestrator imported\n\n## Dependencies\nThis is cleanup AFTER all ZoomStateManager wiring is complete.","status":"closed","priority":2,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:35:17.078144-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:17:53.932686-06:00","closed_at":"2026-01-20T03:17:53.932686-06:00","close_reason":"Closed","dependencies":[{"issue_id":"amnesia-owf","depends_on_id":"amnesia-5so","type":"blocks","created_at":"2026-01-20T01:35:28.908932-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-owf","depends_on_id":"amnesia-0k4","type":"blocks","created_at":"2026-01-20T01:35:28.966733-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-owf","depends_on_id":"amnesia-ggk","type":"blocks","created_at":"2026-01-20T01:35:29.023823-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-pi0","title":"Increase max zoom from 16x to 32x","description":"Max zoom is currently capped at 16x in CameraConstraints DEFAULT_CONSTRAINTS. Should be 32x for detailed viewing of high-resolution PDFs.","status":"closed","priority":2,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T02:56:04.831091-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:11:22.543712-06:00","closed_at":"2026-01-20T03:11:22.543712-06:00","close_reason":"Closed"}
{"id":"amnesia-qna","title":"Implementation: PDF rendering lifecycle harmonization","description":"Implement the validated architecture blueprint:\n- Modify canvas sizing strategy\n- Implement proper double-buffering\n- Fix focal point preservation in constraints\n- Wire content type detection\n- Implement radial tile priority\n- Balance cache budgets","notes":"Implemented 4 of 7 phases: (1) Epoch unification verified, (2) Double-buffer snapshot for mode transitions, (3) Focal-point-radial tile priority, (6) Focal-point-preserving constraint. Build deployed to test vault. Phases 4-5 deferred pending testing.","status":"in_progress","priority":1,"issue_type":"task","created_at":"2026-01-19T23:27:01.623319-06:00","updated_at":"2026-01-19T23:42:51.501529-06:00","labels":["implementation","pdf"],"dependencies":[{"issue_id":"amnesia-qna","depends_on_id":"amnesia-69m","type":"blocks","created_at":"2026-01-19T23:27:01.624434-06:00","created_by":"daemon"},{"issue_id":"amnesia-qna","depends_on_id":"amnesia-oms","type":"blocks","created_at":"2026-01-19T23:27:07.885758-06:00","created_by":"daemon"}]}
{"id":"amnesia-r0m","title":"Investigate: Toolbar zoom control not mapped to PDF reader","description":"The toolbar zoom control doesn't seem to be connected to the PDF reader zoom functionality. Need to investigate the connection between toolbar and pdf-infinite-canvas zoom methods.","status":"closed","priority":2,"issue_type":"bug","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T02:56:03.290548-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:13:54.630092-06:00","closed_at":"2026-01-20T03:13:54.630092-06:00","close_reason":"Closed"}
{"id":"amnesia-ray","title":"Cleanup: Remove dead ZoomOrchestrator code paths","description":"## Context\nAfter wiring ZoomStateManager, ZoomOrchestrator becomes dead code.\nMust ensure complete removal with no lingering references.\n\n## Cleanup Tasks\n1. Mark ZoomOrchestrator as @deprecated (amnesia-owf)\n2. Find and remove ALL import statements\n3. Find and remove ALL instantiation code\n4. Find and remove ALL method calls\n5. Ensure no code paths still use ZoomOrchestrator patterns\n\n## Search Patterns\n```bash\ngrep -r 'ZoomOrchestrator' apps/amnesia/src/\ngrep -r 'zoomStateMachine' apps/amnesia/src/\ngrep -r 'renderVersion' apps/amnesia/src/\ngrep -r 'onZoomGesture.*zoomStateMachine' apps/amnesia/src/\n```\n\n## Quality Gate: Code Reviewer Agent Check\nRun `feature-dev:code-reviewer` agent with prompt:\n```\nReview the PDF renderer codebase for any remaining ZoomOrchestrator usage.\nThis class is deprecated in favor of ZoomStateManager.\nReport any:\n- Import statements for ZoomOrchestrator\n- Variable declarations of type ZoomOrchestrator\n- Method calls to ZoomOrchestrator methods\n- References to renderVersion (replaced by epoch)\n- Patterns that duplicate ZoomOrchestrator functionality\nEnsure COMPLETE removal with no lingering dead code paths.\n```\n\n## Acceptance Criteria\n- [ ] ZoomOrchestrator has @deprecated JSDoc\n- [ ] Zero imports of ZoomOrchestrator (except in its own file)\n- [ ] Zero instantiations of ZoomOrchestrator\n- [ ] Zero calls to ZoomOrchestrator methods\n- [ ] renderVersion completely removed\n- [ ] Code reviewer agent reports ZERO ZoomOrchestrator usage\n\n## Quality Gates\n- [ ] Build passes (no broken references)\n- [ ] Code reviewer agent clean report\n- [ ] `grep ZoomOrchestrator` returns only definition and @deprecated note\n- [ ] `grep renderVersion` returns zero results","status":"closed","priority":2,"issue_type":"chore","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:37:25.234259-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T03:25:59.261174-06:00","closed_at":"2026-01-20T03:25:59.261174-06:00","close_reason":"Updated comments: ZoomOrchestrator is used via ZoomStateMachine alias (not dead code). Added @deprecated notes to zoom-state-machine.ts and index.ts exports. Full removal tracked by amnesia-l0r after migration to ZoomStateManager.","dependencies":[{"issue_id":"amnesia-ray","depends_on_id":"amnesia-owf","type":"blocks","created_at":"2026-01-20T01:38:32.114517-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-u9l","title":"P3: Rewrite Constraint Logic - Soft During Gesture, Hard at End","description":"**Priority:** P3 (Medium-High)\n**Council Consensus:** Math must be unified (no \"fit vs exceed\" branching). Constraints should DECOUPLE during gesture.\n\n## Problem\n`constrainCameraPositionPreservingFocalPoint()` has different formulas for \"content fits\" vs \"content exceeds\":\n```typescript\nif (contentScreenWidth \u003e vpWidth) {\n  const minX = vpWidth / z - contentWidth;  // One formula\n} else {\n  const minX = contentWidth - vpWidth / z;  // Different formula!\n}\n```\n\nThis causes:\n1. Camera position jumps when crossing fit/exceed threshold during zoom\n2. Focal point drifts away from pinch center (~146px)\n3. Hard constraints during gesture override focal point math\n\n## Implementation\n1. **Unified constraint math:** Single formula for all zoom states\n2. **Soft constraints during gesture:** Allow 30% overscroll with rubber-band resistance\n3. **Hard constraints at gesture END:** Animate back to valid bounds\n4. **Remove centering logic during gestures:** Never auto-center while user is zooming\n\n```typescript\nconstrainCameraPosition(\n  camera: Camera,\n  viewport: Size,\n  contentSize: Size,\n  isGestureActive: boolean = false\n): Camera {\n  if (isGestureActive) {\n    return this.applySoftConstraints(camera, viewport, contentSize);\n  }\n  return this.applyHardConstraints(camera, viewport, contentSize);\n}\n```\n\n## Files to Modify\n- `pdf-infinite-canvas.ts` (`constrainCameraPositionPreservingFocalPoint()`)\n- `pdf-canvas-camera.ts` (if constraint logic lives there)","acceptance_criteria":"## Success Criteria (ALL must pass)\n\n### Focal Point Tests (Manual - Use Real Trackpad)\n- [ ] **Drift \u003c 5px:** Zoom from 1x to 16x with pinch; focal point moves \u003c 5px total\n- [ ] **No Jumps:** Crossing content-fits-viewport threshold causes NO visible jump\n- [ ] **Rubber Band:** At document edges, content \"stretches\" slightly before snapping back\n\n### Math Validation\n- [ ] **No Branching:** Constraint code has single unified formula (no if/else on fits/exceeds)\n- [ ] **Gesture Detection:** `isGestureActive` flag correctly tracks pinch/wheel state\n- [ ] **Animation on End:** After gesture, camera animates to valid bounds (not instant snap)\n\n### Test Scenarios\n- [ ] **Edge Pinch:** Pinch zoom near document corner; no content jump\n- [ ] **Threshold Crossing:** Zoom slowly through \"content fits\" threshold; smooth transition\n- [ ] **Overscroll Recovery:** Pull document edge past viewport; springs back smoothly\n\n### Validation Commands\n```javascript\n// Track focal point during zoom\nconst startFocal = { x: 500, y: 300 }; // Set focal point\n// Zoom from 1x to 8x\nconst endFocal = getCurrentFocalPoint();\nconst drift = Math.sqrt((endFocal.x - startFocal.x)**2 + (endFocal.y - startFocal.y)**2);\nconsole.assert(drift \u003c 5, `Focal drift too large: ${drift}px`);\n```\n\n### Regression Checks\n- [ ] Document still constrained to viewport at rest (no permanent overscroll)\n- [ ] Scroll/pan still works normally when not zooming\n- [ ] Single-page PDFs still center correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T00:16:16.430258-06:00","updated_at":"2026-01-20T03:16:40.502464-06:00","closed_at":"2026-01-20T03:16:40.502464-06:00","close_reason":"Closed","labels":["council-validated","p3-medium","pdf","zoom"],"dependencies":[{"issue_id":"amnesia-u9l","depends_on_id":"amnesia-6ii","type":"parent-child","created_at":"2026-01-20T00:16:44.363163-06:00","created_by":"daemon"},{"issue_id":"amnesia-u9l","depends_on_id":"amnesia-w4k","type":"blocks","created_at":"2026-01-20T00:16:51.014893-06:00","created_by":"daemon"}]}
{"id":"amnesia-w4k","title":"P2: Fix Snapshot Mechanism - Replace toDataURL with drawImage","description":"**Priority:** P2 (High)\n**Council Consensus:** UNANIMOUS rejection of `toDataURL()`. It's a synchronous CPU bottleneck (100ms+).\n\n## Problem\nCurrent snapshot creation uses `toDataURL()`:\n```typescript\n// pdf-page-element.ts:1773-1815\nif (this.canvas.width \u003e 0 \u0026\u0026 this.canvas.height \u003e 0 \u0026\u0026 this.isRendered) {\n  const dataUrl = this.canvas.toDataURL('image/png'); // BLOCKING 100ms+\n  this.transitionSnapshot.src = dataUrl;\n}\n```\n\nIssues:\n1. `toDataURL()` forces synchronous PNG encode (100ms+)\n2. `isRendered` check creates race condition\n3. Allocates huge strings, causes GC pressure\n\n## Implementation\n1. Remove `isRendered` check (always attempt if canvas has content)\n2. Replace `toDataURL` with `ctx.drawImage(sourceCanvas, 0, 0)`\n3. Use DOM layering: keep old canvas visible until new content ready\n4. Alternative: use `createImageBitmap()` for async snapshot\n\n```typescript\nprivate createFastSnapshot(): HTMLCanvasElement | null {\n  if (this.canvas.width === 0 || this.canvas.height === 0) return null;\n\n  const snapshot = document.createElement('canvas');\n  snapshot.width = this.canvas.width;\n  snapshot.height = this.canvas.height;\n  const ctx = snapshot.getContext('2d');\n  ctx?.drawImage(this.canvas, 0, 0); // Fast GPU copy\n  return snapshot;\n}\n```\n\n## Files to Modify\n- `pdf-page-element.ts` (`prepareForTiledRender()`, `clearTransitionSnapshot()`)","acceptance_criteria":"## Success Criteria (ALL must pass)\n\n### Performance Tests\n- [ ] **No toDataURL:** `grep -r \"toDataURL\" src/reader/renderer/pdf/` returns no hot-path hits\n- [ ] **Snapshot Speed:** Snapshot creation \u003c 5ms (measure with `performance.now()`)\n- [ ] **No GC Spikes:** Chrome DevTools Memory tab shows no large string allocations during zoom\n\n### Visual Tests (Manual)\n- [ ] **Zero Blank Frames:** Mode transition (cross 4x threshold) shows NO blank period\n- [ ] **Smooth Handoff:** Old content fades to new content seamlessly\n- [ ] **Correct Position:** Snapshot appears at exact same position as live canvas\n\n### Test Scenarios\n- [ ] **Rapid Mode Transitions:** Zoom through 4x threshold 10 times rapidly; never see blank\n- [ ] **Large Document:** 100+ page PDF; mode transitions still smooth\n- [ ] **Memory Stability:** 50 zoom cycles; memory usage stable (no leak)\n\n### Validation Commands\n```javascript\n// Verify no toDataURL in hot path\nperformance.mark('snapshot-start');\n// Trigger mode transition\nperformance.mark('snapshot-end');\nperformance.measure('snapshot', 'snapshot-start', 'snapshot-end');\n// Should be \u003c 5ms\n```\n\n### Regression Checks\n- [ ] Snapshot still visually matches canvas content\n- [ ] Z-index layering doesn't break other UI elements\n- [ ] Snapshot properly cleaned up after transition","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-20T00:15:55.624486-06:00","updated_at":"2026-01-20T00:42:36.794892-06:00","closed_at":"2026-01-20T00:42:36.794892-06:00","close_reason":"Implemented: Replaced toDataURL with drawImage in prepareForTiledRender(). Changed transitionSnapshot from HTMLImageElement to HTMLCanvasElement. Added timing measurement. Snapshot creation now ~1ms instead of 100ms+.","labels":["council-validated","p2-high","pdf","zoom"],"dependencies":[{"issue_id":"amnesia-w4k","depends_on_id":"amnesia-6ii","type":"parent-child","created_at":"2026-01-20T00:16:44.13806-06:00","created_by":"daemon"},{"issue_id":"amnesia-w4k","depends_on_id":"amnesia-1fr","type":"blocks","created_at":"2026-01-20T00:16:50.806912-06:00","created_by":"daemon"}]}
{"id":"amnesia-we4","title":"Wire ZoomStateManager as canonical zoom state source (architectural cleanup)","description":"## Context\nLLM Council approved Two-Track Pipeline with conditional note:\n'Option B (patch renderVersion) acceptable as temporary bridge to Option A (wire ZoomStateManager)'.\n\nZoomStateManager has CORRECT epoch logic that increments on every zoom change.\nCurrently UNUSED - entire class is dead code despite being well-designed.\n\n## The Problem\nTwo parallel epoch systems exist:\n1. `renderVersion` in pdf-infinite-canvas.ts (ACTIVE, BROKEN)\n2. `ZoomStateManager.epoch` in zoom-state-manager.ts (UNUSED, CORRECT)\n\nWe're patching the broken one (amnesia-3of) as a quick fix.\nThis issue tracks the architectural cleanup to wire the correct implementation.\n\n## Files to Change\n1. `zoom-state-manager.ts` - Add rebound detection, gesture timing\n2. `pdf-infinite-canvas.ts` - Replace zoomStateMachine with zoomStateManager\n3. `zoom-orchestrator.ts` - Mark as @deprecated\n4. `pdf-gesture-handler.ts` - Wire ZoomStateManager\n5. `render-coordinator.ts` - Add epoch tagging\n\n## Benefits\n- Single source of truth for zoom state\n- Clean separation of concerns\n- No more 6 different zoom state locations that desync\n- Proper epoch validation built-in\n\n## Acceptance Criteria\n- [ ] ZoomStateManager instantiated and wired\n- [ ] renderVersion references removed\n- [ ] ZoomOrchestrator marked deprecated\n- [ ] Epoch increments on every zoom change via ZoomStateManager\n- [ ] All zoom state reads go through ZoomStateManager\n\n## Quality Gates\n- [ ] Build passes\n- [ ] All existing tests pass\n- [ ] Manual zoom tests pass\n- [ ] No zoom state desync bugs\n\n## Dependencies\nShould be done AFTER:\n- amnesia-ntj (zoom clamp fix)\n- amnesia-3of (epoch increment patch)\n- amnesia-166 (rebound wiring)\n\nThis is architectural cleanup, not bug fix.","status":"open","priority":3,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:33:48.806019-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:33:48.806019-06:00","dependencies":[{"issue_id":"amnesia-we4","depends_on_id":"amnesia-ntj","type":"blocks","created_at":"2026-01-20T01:33:55.206921-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-we4","depends_on_id":"amnesia-3of","type":"blocks","created_at":"2026-01-20T01:33:55.256582-06:00","created_by":"Josue Guevara"},{"issue_id":"amnesia-we4","depends_on_id":"amnesia-166","type":"blocks","created_at":"2026-01-20T01:33:55.306915-06:00","created_by":"Josue Guevara"}]}
{"id":"amnesia-x9v","title":"Add rebound detection to ZoomStateManager","description":"## Context\nZoomStateManager needs rebound detection to filter trackpad inertia events at zoom boundaries.\nThis is required before wiring ZoomStateManager to the zoom pipeline.\n\n## File\n`apps/amnesia/src/reader/renderer/pdf/zoom-state-manager.ts`\n\n## Implementation\nAdd these methods to ZoomStateManager:\n\n```typescript\nprivate gestureEndTime: number = 0;\n\n// Call when gesture ends\nmarkGestureEnd(): void {\n  this.gestureEndTime = performance.now();\n}\n\n// Detect rebound zoom-out at max zoom\nisReboundZoomOut(newZoom: number): boolean {\n  const currentZoom = this.state.zoom;\n  const isAtMax = currentZoom \u003e= this.config.maxZoom - 0.01;\n  const isZoomingOut = newZoom \u003c currentZoom;\n  const timeSinceGestureEnd = performance.now() - this.gestureEndTime;\n  const inReboundWindow = timeSinceGestureEnd \u003c 600; // 600ms window\n  \n  return isAtMax \u0026\u0026 isZoomingOut \u0026\u0026 inReboundWindow;\n}\n\n// Keep gesture alive during rebound filtering\nsignalOngoingActivity(): void {\n  // Reset gesture-end timer so settling doesn't trigger\n  this.lastActivityTime = performance.now();\n}\n```\n\n## Acceptance Criteria\n- [ ] `gestureEndTime` tracked when gesture ends\n- [ ] `isReboundZoomOut()` returns true at max zoom within 600ms window\n- [ ] `signalOngoingActivity()` resets activity timer\n- [ ] Unit tests for rebound detection\n\n## Quality Gates\n- [ ] Build passes\n- [ ] Unit tests pass\n- [ ] TypeScript types correct","status":"closed","priority":1,"issue_type":"task","owner":"105689291+jjjjguevara@users.noreply.github.com","created_at":"2026-01-20T01:34:18.741216-06:00","created_by":"Josue Guevara","updated_at":"2026-01-20T01:48:02.933344-06:00","closed_at":"2026-01-20T01:48:02.933344-06:00","close_reason":"Closed"}
{"id":"amnesia-z8v","title":"P4: Defer Mode Transitions to Gesture End","description":"**Priority:** P4 (Medium)\n**Council Consensus:** Do not swap rendering modes (Full Page ↔ Tiled) during a pinch.\n\n## Problem\nMode transition check happens AFTER camera moves:\n```typescript\n// 1. zoomCameraToPoint() → camera moves\n// 2. constraint applied\n// 3. MODE CHECK → detects transition\n// 4. prepareForFullPageRender() → canvas.opacity='0' (BLANK!)\n```\n\nThis causes:\n1. Snapshot captures wrong position (camera already moved)\n2. Blank flash during mode transition\n3. Visual jump when entering/exiting tiled mode\n\n## Implementation\n1. **Detect transition BEFORE camera moves:** Check if zoom will cross threshold\n2. **Capture snapshot at current position:** Before any state changes\n3. **Defer actual mode switch:** Keep current mode during gesture\n4. **Pre-render in background:** Start preparing tiles for target mode\n5. **Execute transition on gesture end:** Swap seamlessly when content ready\n\n```typescript\nhandleZoomChange(newZoom: number, isGestureActive: boolean) {\n  const shouldBeTiled = newZoom \u003e= this.TILING_THRESHOLD;\n\n  if (isGestureActive) {\n    // Note pending transition, don't execute yet\n    this.pendingMode = shouldBeTiled ? 'tiled' : 'full-page';\n    // Pre-render in background\n    this.preRenderForMode(this.pendingMode, newZoom);\n  } else {\n    // Gesture ended, execute transition\n    if (this.pendingMode !== this.currentMode) {\n      this.executeTransition(this.pendingMode);\n    }\n  }\n}\n```\n\n## Files to Modify\n- `pdf-infinite-canvas.ts` (mode transition logic in `zoomAtPoint()`)\n- `pdf-page-element.ts` (`prepareForTiledRender()`, `prepareForFullPageRender()`)","acceptance_criteria":"## Success Criteria (ALL must pass)\n\n### Visual Tests (Manual)\n- [ ] **No Blank Frames:** Crossing 4x threshold shows NO blank period\n- [ ] **Smooth Transition:** Mode switch has fade/crossfade effect\n- [ ] **Hysteresis Works:** Oscillating around 4x doesn't cause rapid mode flipping\n\n### State Machine Tests\n- [ ] **Gesture Detection:** Mode switch only happens when `isGestureActive === false`\n- [ ] **Pending Mode Tracked:** `this.pendingMode` correctly set during gesture\n- [ ] **Pre-render Triggered:** Console shows background render started during gesture\n\n### Test Scenarios\n- [ ] **Zoom Through Threshold:** Pinch from 2x → 8x; no visual discontinuity at 4x\n- [ ] **Threshold Oscillation:** Hover zoom around 3.8-4.2x for 5 seconds; no flicker\n- [ ] **Quick Reverse:** Zoom to 6x, immediately back to 2x; transitions are smooth\n\n### Validation Commands\n```javascript\n// Track mode transitions\nlet transitionCount = 0;\nconst originalPrepare = element.prepareForTiledRender;\nelement.prepareForTiledRender = function() {\n  transitionCount++;\n  console.log(`Mode transition #${transitionCount}`);\n  return originalPrepare.call(this);\n};\n\n// Zoom through threshold multiple times\n// Count should be LOW (1-2 per direction, not dozens)\n```\n\n### Regression Checks\n- [ ] Tile rendering still activates eventually at high zoom\n- [ ] Full-page rendering still works at low zoom\n- [ ] No memory leaks from pending pre-renders","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-20T00:16:36.002394-06:00","updated_at":"2026-01-20T03:30:07.978163-06:00","closed_at":"2026-01-20T03:30:07.978163-06:00","close_reason":"Implemented deferred mode transitions: pendingModeTransition tracks target mode during gesture, executeModeTransition() executes on gesture end. Prevents blank frames when crossing 4.0 threshold during pinch.","labels":["council-validated","p4-medium","pdf","zoom"],"dependencies":[{"issue_id":"amnesia-z8v","depends_on_id":"amnesia-6ii","type":"parent-child","created_at":"2026-01-20T00:16:44.545278-06:00","created_by":"daemon"},{"issue_id":"amnesia-z8v","depends_on_id":"amnesia-u9l","type":"blocks","created_at":"2026-01-20T00:16:51.182924-06:00","created_by":"daemon"}]}
